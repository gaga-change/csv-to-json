<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>在线csv转json</title>
    <link rel="icon" sizes="any" mask href="//img.junn.top/favicon.ico">
    <link rel="stylesheet" href="//cdn.junn.top/bootstrap/4.1.1/css/bootstrap.min.css">
    <meta name='description' content='在线csv转json' />
    <meta name='keywords' content='在线csv转json' />
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col">
                <form id="formControl">
                    <div class="form-group">
                        <label for="formControlFile">上传文件</label>
                        <input type="file" class="form-control-file" name="file" id="formControlFile">
                    </div>
                    <button id="submit" type="submit" class="btn btn-primary ">提交</button>
                </form>
            </div>
        </div>
    </div>
</body>
<script src="//cdn.junn.top/jquery/3.3.1/jquery.min.js"></script>
<script src="//cdn.junn.top/bootstrap/4.1.1/js/bootstrap.min.js"></script>
<script>
    $('#submit').click(function (e) {
        e.preventDefault();
        var fileEle = $('#formControlFile')
        var files = fileEle.get(0).files
        // 获取 csv 文件
        var file = files[0]
        if (!file) {
            return alert('请选择文件~')
        }
        if (!checkIsCsv(file.name)) {
            return alert('选择的文件不是 .csv 后缀的，请重新选择！')
        }
        console.log(file)
        upload()
    })

    /**
     * 校验文件后缀是否是 .csv
     */
    function checkIsCsv(path) {
        if (/.csv$/.test(path)) {
            return true
        } else {
            return false
        }
    }

    var uploading = false;
    /**
     * 上传文件
     */
    function upload() {
        if (uploading) {
            alert("文件正在上传中，请稍候");
            return false;
        }
        $.ajax({
            url: "/api/turn",
            type: 'POST',
            data: new FormData($('#formControl')[0]),
            processData: false,
            contentType: false,
            dataType: "json",
            beforeSend: function () {
                uploading = true;
            },
            success: function (data) {
                console.log(data)
                funDownload(JSON.stringify(data), 'data.json')
                uploading = false;
            },
            error: function (data) {
                alert('上传失败')
            }
        })
    }

    function funDownload(content, filename) {
        // 创建隐藏的可下载链接
        var eleLink = document.createElement('a');
        eleLink.download = filename;
        eleLink.style.display = 'none';
        // 字符内容转变成blob地址
        var blob = new Blob([content]);
        eleLink.href = URL.createObjectURL(blob);
        // 触发点击
        document.body.appendChild(eleLink);
        eleLink.click();
        // 然后移除
        document.body.removeChild(eleLink);
    }
</script>

</html>